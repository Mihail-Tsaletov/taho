<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Назначение заказов</title>
  <link rel="stylesheet" th:href="@{/css/styles.css}">
  <style>
    body {font-family: Arial, sans-serif; margin:0; background:#f4f4f4; display:flex; height:100vh;}
    .column {padding:20px; overflow-y:auto; width:50%; box-sizing:border-box;}
    .left  {background:white; border-right:1px solid #ddd;}
    .right {background:#fafafa;}
    h2 {margin-top:0; color:#333;}
    .order-card {
      background:#fff; border:1px solid #ddd; border-radius:8px;
      padding:15px; margin-bottom:12px; box-shadow:0 2px 6px rgba(0,0,0,0.05);
    }
    select {width:100%; padding:8px; margin-top:8px; border-radius:5px; border:1px solid #ccc;}
    .success {color:green; font-weight:bold; margin-top:8px;}
    #driversLoading {color:#666; text-align:center; padding:40px;}
  </style>
</head>
<body>

<div class="column left">
  <h2>Новые заказы <span id="ordersCount" style="color:#28a745"></span></h2>
  <div id="ordersList"></div>
</div>

<div class="column right">
  <h2>Доступные водители <span id="driversCount" style="color:#28a745"></span></h2>
  <div id="driversLoading">Загрузка водителей...</div>
  <div id="driversList"></div>
</div>

<script th:inline="javascript">
  const STATUS = "PENDING"; // или тот статус, который нужно назначать

  let drivers = []; // кэшируем список водителей

  // === ЗАГРУЗКА ЗАКАЗОВ ===
  function loadOrders() {
    fetch(`/api/orders/getOrdersWithStatus?status=${STATUS}`)
            .then(r => r.json())
            .then(orders => {
              document.getElementById('ordersCount').textContent = `(${orders.length})`;
              const container = document.getElementById('ordersList');
              container.innerHTML = '';

              if (orders.length === 0) {
                container.innerHTML = '<p style="color:#888;text-align:center;padding:40px">Нет заказов для назначения</p>';
                return;
              }

              orders.forEach(order => {
                const div = document.createElement('div');
                div.className = 'order-card';
                div.innerHTML = `
                        <strong>Заказ #${order.orderId}</strong><br>
                        <small>Создан: ${order.orderTime ? new Date(order.orderTime.seconds*1000).toLocaleString('ru-RU') : '—'}</small><br><br>
                        Откуда: <strong>${order.startPoint}</strong><br>
                        Куда: <strong>${order.endPoint}</strong><br>
                        Цена: <strong>${order.price || 0} ₽</strong>
                        <select data-order-id="${order.orderId}">
                            <option value="">— Выберите водителя —</option>
                            ${drivers.map(d => `<option value="${d.driverId}">${d.name} (${d.phoneNumber})</option>`).join('')}
                        </select>
                        <div class="success" id="msg-${order.orderId}"></div>
                    `;

                // Обработчик выбора водителя
                div.querySelector('select').addEventListener('change', function() {
                  const driverId = this.value;
                  const orderId = this.dataset.orderId;
                  if (!driverId) return;

                  const msgEl = document.getElementById('msg-' + orderId);
                  msgEl.textContent = 'Назначаем...';
                  this.disabled = true;

                  fetch('/api/orders/putDriverInOrder', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                      orderId: orderId,
                      driverId: driverId
                    })
                  })
                          .then(r => r.text())
                          .then(resp => {
                            msgEl.textContent = 'Водитель назначен!';
                            msgEl.style.color = 'green';
                            // Убираем заказ из списка через 1 сек
                            setTimeout(() => loadOrders(), 1000);
                          })
                          .catch(err => {
                            console.error(err);
                            msgEl.textContent = 'Ошибка!';
                            msgEl.style.color = 'red';
                            this.disabled = false;
                          });
                });

                container.appendChild(div);
              });
            });
  }

  // === ЗАГРУЗКА ВОДИТЕЛЕЙ ===
  function loadDrivers() {
    fetch('/api/users/getAvailableDrivers')
            .then(r => r.json())
            .then(list => {
              drivers = list; // сохраняем глобально
              document.getElementById('driversCount').textContent = `(${drivers.length})`;
              document.getElementById('driversLoading').style.display = 'none';

              const container = document.getElementById('driversList');
              container.innerHTML = '';

              if (drivers.length === 0) {
                container.innerHTML = '<p style="color:#888">Нет доступных водителей</p>';
                return;
              }

              drivers.forEach(d => {
                const div = document.createElement('div');
                div.className = 'order-card';
                div.innerHTML = `
                        <strong>${d.name}</strong><br>
                        Телефон: ${d.phone}<br>
                        Авто: ${d.carModel || '—'} (${d.carNumber || '—'})
                    `;
                container.appendChild(div);
              });
            });
  }

  // === СТАРТ ===
  loadDrivers();
  loadOrders();

  // Обновление каждые 10 секунд
  setInterval(() => {
    loadOrders();
    loadDrivers();
  }, 10000);
</script>

</body>
</html>