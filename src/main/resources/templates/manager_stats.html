<!DOCTYPE html>
<html lang="ru" class="h-full" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Панель менеджера Taho</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    [x-cloak] { display: none !important; }
  </style>
</head>
<body class="h-full bg-gray-100 font-sans antialiased">
<div x-data="managerApp()" x-init="init()" x-cloak class="h-full flex flex-col">

  <!-- Header -->
  <header class="bg-white shadow">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex">
          <div class="flex-shrink-0 flex items-center">
            <span class="text-xl font-bold text-indigo-600">Taho Manager</span>
          </div>
          <nav class="hidden sm:ml-6 sm:flex sm:space-x-8">
            <button @click="tab = 'balance'"
                    :class="{ 'border-indigo-500 text-indigo-600': tab === 'balance', 'border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700': tab !== 'balance' }"
                    class="inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
              Пополнение баланса
            </button>
            <button @click="tab = 'stats'"
                    :class="{ 'border-indigo-500 text-indigo-600': tab === 'stats', 'border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700': tab !== 'stats' }"
                    class="inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
              Статистика водителей
            </button>
            <button @click="tab = 'assign'"
                    :class="{ 'border-indigo-500 text-indigo-600': tab === 'assign', 'border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700': tab !== 'assign' }"
                    class="inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
              Назначение заказов
            </button>
          </nav>
        </div>

        <div class="flex items-center space-x-4" th:if="${currentUserName}">
          <span class="text-sm text-gray-600">Менеджер:</span>
          <span class="text-sm font-medium text-indigo-700" th:text="${currentUserName}"></span>
        </div>
      </div>
    </div>
  </header>

  <!-- Main content -->
  <main class="flex-1 overflow-auto pb-12">
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">

      <!-- Вкладка 1: Пополнение баланса -->
      <div x-show="tab === 'balance'" class="px-4 py-6 sm:px-0">
        <div class="bg-white shadow rounded-lg p-6">
          <h2 class="text-lg font-medium text-gray-900 mb-6">Пополнение баланса водителю</h2>
          <form @submit.prevent="addBalance">
            <div class="grid grid-cols-1 gap-6 max-w-md">
              <div>
                <label for="phone" class="block text-sm font-medium text-gray-700">Номер телефона водителя</label>
                <input x-model="phone" type="tel" id="phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="+79991234567" required>
              </div>
              <div>
                <label for="amount" class="block text-sm font-medium text-gray-700">Сумма (руб)</label>
                <input x-model.number="amount" type="number" id="amount" min="1" step="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="500" required>
              </div>
            </div>
            <div class="mt-8">
              <button type="submit" :disabled="loading || !phone || !amount"
                      class="inline-flex justify-center py-3 px-6 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">
                <span x-show="!loading">Пополнить баланс</span>
                <span x-show="loading">Пополняем...</span>
              </button>
            </div>
            <div x-show="successMessage" class="mt-6 text-green-600 text-lg font-medium" x-text="successMessage"></div>
            <div x-show="errorMessage" class="mt-6 text-red-600 text-lg font-medium" x-text="errorMessage"></div>
          </form>
        </div>
      </div>

      <!-- Вкладка 2: Статистика водителей -->
      <div x-show="tab === 'stats'" class="px-4 py-6 sm:px-0">
        <div class="bg-white shadow rounded-lg overflow-hidden">
          <!-- Список водителей -->
          <div class="p-6 border-b">
            <h2 class="text-lg font-medium text-gray-900 mb-4">Водители</h2>
            <div x-show="loadingDrivers" class="text-center py-10 text-gray-500">Загрузка водителей...</div>
            <div x-show="!loadingDrivers && drivers.length === 0" class="text-center py-10 text-gray-500">Водителей пока нет</div>
            <ul x-show="!loadingDrivers && drivers.length > 0" class="divide-y divide-gray-200">
              <template x-for="driver in drivers" :key="driver.driverId">
                <li @click="selectDriver(driver)"
                    :class="{ 'bg-indigo-50': selectedDriver && selectedDriver.driverId === driver.driverId }"
                    class="px-4 py-4 sm:px-6 cursor-pointer hover:bg-gray-50 transition">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-sm font-medium text-gray-900" x-text="driver.name || 'Без имени'"></p>
                      <p class="text-sm text-gray-500" x-text="driver.phoneNumber || 'Нет номера'"></p>
                    </div>
                    <div class="text-sm text-gray-500" x-text="(driver.balance || 0).toFixed(2) + ' ₽'"></div>
                  </div>
                </li>
              </template>
            </ul>
          </div>

          <!-- Статистика выбранного водителя -->
          <div x-show="selectedDriver" class="p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4" x-text="'Заказы водителя: ' + (selectedDriver.name || 'Без имени')"></h3>
            <p class="text-sm text-gray-600 mb-4">
              Общая сумма по заказам:
              <span class="font-medium text-gray-900" x-text="selectedDriverTotal.toFixed(2) + ' ₽'"></span>
            </p>

            <div class="mb-4 flex justify-end">
              <select x-model="sortOrder" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                <option value="desc">По новизне (сначала новые)</option>
                <option value="asc">По старшинству (сначала старые)</option>
              </select>
            </div>

            <div x-show="loadingOrders" class="text-center py-10 text-gray-500">Загрузка заказов...</div>
            <div x-show="!loadingOrders && sortedOrders.length === 0" class="text-center py-10 text-gray-500">У водителя пока нет заказов</div>
            <div x-show="!loadingOrders && sortedOrders.length > 0" class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-300">
                <thead class="bg-gray-50">
                <tr>
                  <th class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900">Дата</th>
                  <th class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Откуда → Куда</th>
                  <th class="px-3 py-3.5 text-right text-sm font-semibold text-gray-900">Цена</th>
                </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 bg-white">
                <template x-for="order in sortedOrders" :key="order.orderId">
                  <tr class="hover:bg-gray-50">
                    <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm text-gray-900" x-text="formatDate(order.orderTime)"></td>
                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500" x-text="order.startAddress + ' → ' + order.endAddress"></td>
                    <td class="whitespace-nowrap px-3 py-4 text-sm text-right text-gray-900 font-medium" x-text="order.price != null ? order.price.toFixed(2) + ' ₽' : '—'"></td>
                  </tr>
                </template>
                </tbody>
              </table>
            </div>
          </div>

          <div x-show="!selectedDriver && !loadingDrivers" class="p-6 text-center text-gray-500">
            Выберите водителя из списка
          </div>
        </div>
      </div>

      <!-- Вкладка 3: Назначение заказов -->
      <div x-show="tab === 'assign'" class="px-4 py-6 sm:px-0">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Новые заказы -->
          <div class="bg-white shadow rounded-lg overflow-hidden">
            <div class="p-6 border-b bg-gray-50">
              <h2 class="text-lg font-medium text-gray-900">
                Новые заказы (ожидают назначения)
                <span class="ml-2 text-green-600 font-semibold" x-text="'(' + pendingOrders.length + ')'"></span>
              </h2>
              <div x-show="refreshingAssign" class="absolute top-2 right-4 text-xs text-indigo-500 animate-pulse">
                ↻ Обновление...
              </div>
            </div>
            <div class="p-6 max-h-[70vh] overflow-y-auto">
              <div x-show="initialLoadingOrders" class="text-center py-12 text-gray-500">Загрузка заказов...</div>
              <div x-show="!initialLoadingOrders && pendingOrders.length === 0" class="text-center py-12 text-gray-500">Нет заказов со статусом PENDING</div>
              <div x-show="!initialLoadingOrders && pendingOrders.length > 0" class="space-y-4">
                <template x-for="order in pendingOrders" :key="order.orderId">
                  <div class="border border-gray-200 rounded-lg p-5 bg-white shadow-sm hover:shadow-md transition">
                    <div class="flex justify-between items-start mb-3">
                      <div>
                        <p class="font-medium text-gray-900">Заказ #<span x-text="order.orderId"></span></p>
                        <p class="text-sm text-gray-500 mt-1" x-text="formatDate(order.orderTime)"></p>
                      </div>
                      <span class="text-sm font-medium text-gray-900" x-text="order.price != null ? order.price.toFixed(2) + ' ₽' : '—'"></span>
                    </div>
                    <div class="text-gray-700 mb-4 space-y-1">
                      <p><strong>Откуда:</strong> <span x-text="order.startAddress || '—'"></span></p>
                      <p><strong>Куда:</strong> <span x-text="order.endAddress || '—'"></span></p>
                    </div>
                    <select
                            @change="handleDriverSelect(order.orderId, $event.target.value)"
                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                      <option value="">— Выберите водителя —</option>
                      <template x-for="driver in availableDrivers" :key="driver.driverId">
                        <option :value="driver.driverId" x-text="driver.name + ' (' + (driver.phone || driver.phoneNumber || '—') + ')'"></option>
                      </template>
                    </select>
                    <div x-show="assignmentMessages[order.orderId]"
                         class="mt-3 text-sm font-medium"
                         :class="assignmentMessages[order.orderId]?.success ? 'text-green-600' : 'text-red-600'"
                         x-text="assignmentMessages[order.orderId]?.text || ''">
                    </div>
                </template>
              </div>
            </div>
          </div>

          <!-- Доступные водители -->
          <div class="bg-white shadow rounded-lg overflow-hidden">
            <div class="p-6 border-b bg-gray-50">
              <h2 class="text-lg font-medium text-gray-900">
                Доступные водители
                <span class="ml-2 text-green-600 font-semibold" x-text="'(' + availableDrivers.length + ')'"></span>
              </h2>
            </div>
            <div class="p-6 max-h-[70vh] overflow-y-auto">
              <div x-show="initialLoadingDrivers" class="text-center py-12 text-gray-500">Загрузка водителей...</div>
              <div x-show="!initialLoadingDrivers && availableDrivers.length === 0" class="text-center py-12 text-gray-500">Нет доступных водителей</div>
              <div x-show="!initialLoadingDrivers && availableDrivers.length > 0" class="space-y-4">
                <template x-for="driver in availableDrivers" :key="driver.driverId">
                  <div class="border border-gray-200 rounded-lg p-5 bg-white shadow-sm">
                    <p class="font-medium text-gray-900" x-text="driver.name || 'Без имени'"></p>
                    <p class="text-sm text-gray-600 mt-1">
                      Телефон: <span x-text="driver.phone || driver.phoneNumber || '—'"></span>
                    </p>
                    <p class="text-sm text-gray-600 mt-1">
                      Авто: <span x-text="driver.carModel || '—'"></span>
                      (<span x-text="driver.carNumber || '—'"></span>)
                    </p>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>
</div>

<script>
  function managerApp() {
    return {
      // Общие свойства
      tab: 'stats',
      phone: '',
      amount: '',
      loading: false,
      successMessage: '',
      errorMessage: '',

      // Для вкладки статистики
      drivers: [],
      selectedDriver: null,
      loadingDrivers: false,
      loadingOrders: false,
      sortOrder: 'desc',

      // Для вкладки назначения
      pendingOrders: [],
      availableDrivers: [],
      initialLoadingOrders: false,
      initialLoadingDrivers: false,
      selectedDrivers: {},
      assignmentMessages: {},
      refreshingAssign: false,

      init() {
        this.loadDrivers();  // для вкладки статистики один раз при старте
        this.$nextTick(() => {
          this.selectedDrivers = {}; // принудительно реактивный объект
        });

        // Автообновление ТОЛЬКО для вкладки «Назначение заказов»
        setInterval(() => {
          if (this.tab === 'assign') {
            this.refreshingAssign = true;
            Promise.all([
              this.refreshPendingOrders(),     // ← метод БЕЗ loading
              this.refreshAvailableDrivers()
            ]).finally(() => {
              this.refreshingAssign = false;
            });
          }
        }, 8000);

        this.$watch('tab', (newTab) => {
          if (newTab === 'assign') {
            // Первая загрузка при открытии вкладки — ПОКАЗЫВАЕМ «Загрузка...»
            this.initialLoadingOrders = true;
            this.initialLoadingDrivers = true;

            Promise.all([
              this.loadPendingOrders(),     // ← метод С loading
              this.loadAvailableDrivers()
            ]);
          }
        });
      },

      async refreshData() {
        if (this.tab === 'stats') {
          await this.loadDrivers();
          if (this.selectedDriver) await this.selectDriver(this.selectedDriver);
        } else if (this.tab === 'assign') {
          await this.loadPendingOrders();
          await this.loadAvailableDrivers();
        }
      },

      handleDriverSelect(orderId, driverId) {
        console.log('Выбран водитель:', driverId, 'для заказа:', orderId);

        // Обычное присваивание — Alpine 3 отследит
        this.selectedDrivers[orderId] = driverId;

        // Если выбрали водителя — сразу назначаем
        if (driverId) {
          this.assignDriver(orderId);
        }
      },

      // ───────────────────────────────────────────────
      // Методы для вкладки "Пополнение баланса"
      // ───────────────────────────────────────────────
      async addBalance() {
        if (!this.phone || !this.amount) {
          this.errorMessage = 'Укажите телефон и сумму';
          return;
        }
        this.loading = true;
        this.successMessage = '';
        this.errorMessage = '';

        try {
          const url = `/manager/addBalance?driverPhoneNumber=${encodeURIComponent(this.phone)}&value=${this.amount}`;
          const res = await fetch(url, { method: 'POST' });
          if (!res.ok) {
            const err = await res.text();
            throw new Error(err || 'Ошибка сервера');
          }
          this.successMessage = `Баланс пополнен на ${this.amount} ₽`;
          this.phone = '';
          this.amount = '';
          await this.loadDrivers(); // обновляем список
        } catch (err) {
          this.errorMessage = err.message || 'Не удалось пополнить баланс';
        } finally {
          this.loading = false;
        }
      },

      // ───────────────────────────────────────────────
      // Методы для вкладки "Статистика водителей"
      // ───────────────────────────────────────────────
      async loadDrivers() {
        this.loadingDrivers = true;
        try {
          const res = await fetch('/api/users/getAllDrivers');
          if (!res.ok) throw new Error();
          this.drivers = await res.json();
        } catch {
          this.errorMessage = 'Не удалось загрузить водителей';
        } finally {
          this.loadingDrivers = false;
        }
      },

      async selectDriver(driver) {
        this.selectedDriver = driver;
        this.loadingOrders = true;

        try {
          const res = await fetch(`/api/orders/getAllOrdersByDriverId?driverId=${driver.driverId}`);
          if (!res.ok) throw new Error();
          const orders = await res.json();
          driver.orders = orders.map(o => ({
            orderId: o.orderId || '—',
            orderTime: o.orderTime,
            startAddress: o.startAddress || '—',
            endAddress: o.endAddress || '—',
            price: o.price != null ? Number(o.price) : null
          }));
        } catch {
          driver.orders = [];
          this.errorMessage = 'Не удалось загрузить заказы';
        } finally {
          this.loadingOrders = false;
        }
      },

      get selectedDriverTotal() {
        if (!this.selectedDriver?.orders) return 0;
        return this.selectedDriver.orders.reduce((sum, o) => sum + (o.price || 0), 0);
      },

      get sortedOrders() {
        if (!this.selectedDriver?.orders) return [];
        let orders = [...this.selectedDriver.orders];
        return orders.sort((a, b) => {
          if (!a.orderTime) return 1;
          if (!b.orderTime) return -1;
          const da = new Date(a.orderTime);
          const db = new Date(b.orderTime);
          if (isNaN(da) || isNaN(db)) return 1;
          return this.sortOrder === 'desc' ? db - da : da - db;
        });
      },

      // ───────────────────────────────────────────────
      // Методы для вкладки "Назначение заказов"
      // ───────────────────────────────────────────────
      async loadPendingOrders() {
        this.initialLoadingOrders = true;
        try {
          const res = await fetch('/api/orders/getOrdersWithStatus?status=PENDING');
          if (!res.ok) throw new Error('Ошибка загрузки заказов');
          const fresh = await res.json();
          if (fresh && Array.isArray(fresh)) {
            this.pendingOrders = fresh;
          }
        } catch (err) {
          console.error('Ошибка первой загрузки pending заказов', err);
        } finally {
          this.initialLoadingOrders = false;
        }
      },

      async loadAvailableDrivers() {
        this.initialLoadingDrivers = true;
        try {
          const res = await fetch('/api/users/getAvailableDrivers');
          if (!res.ok) throw new Error('Ошибка загрузки водителей');
          const fresh = await res.json();
          if (fresh && Array.isArray(fresh)) {
            this.availableDrivers = fresh;
          }
        } catch (err) {
          console.error('Ошибка первой загрузки доступных водителей', err);
        } finally {
          this.initialLoadingDrivers = false;
        }
      },

      async refreshPendingOrders() {
        try {
          const res = await fetch('/api/orders/getOrdersWithStatus?status=PENDING');
          if (!res.ok) return;
          const fresh = await res.json();
          if (fresh && Array.isArray(fresh)) {
            this.pendingOrders = fresh;
          }
        } catch (err) {
          console.warn('Фоновое обновление заказов не удалось', err);
          // старые данные остаются!
        }
      },

      async refreshAvailableDrivers() {
        try {
          const res = await fetch('/api/users/getAvailableDrivers');
          if (!res.ok) return;
          const fresh = await res.json();
          if (fresh && Array.isArray(fresh)) {
            this.availableDrivers = fresh;
          }
        } catch (err) {
          console.warn('Фоновое обновление водителей не удалось', err);
          // старые данные остаются!
        }
      },

      async assignDriver(orderId) {
        const driverId = this.selectedDrivers[orderId];

        console.log('assignDriver вызван для заказа:', orderId, 'водитель:', driverId);

        if (!driverId) {
          console.warn('driverId пустой → прерываем');
          return;
        }

        // Просто присваиваем — Alpine 3 отреагирует автоматически
        this.assignmentMessages[orderId] = { text: 'Назначаем...', success: false };

        try {
          console.log('Отправляем POST:', { orderId, driverId });

          const res = await fetch('/api/orders/putDriverInOrder', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ orderId, driverId })
          });

          if (!res.ok) {
            const errText = await res.text();
            throw new Error(errText || `HTTP ${res.status}`);
          }

          this.assignmentMessages[orderId] = { text: 'Водитель назначен!', success: true };

          setTimeout(() => {
            this.pendingOrders = this.pendingOrders.filter(o => o.orderId !== orderId);
            delete this.selectedDrivers[orderId];
            delete this.assignmentMessages[orderId];
          }, 1800);

        } catch (err) {
          console.error('Ошибка назначения:', err);
          this.assignmentMessages[orderId] = { text: 'Ошибка: ' + err.message, success: false };
        }
      },

      // Общий форматтер даты
      formatDate(dateInput) {
        if (!dateInput) return '—';
        let date;
        if (typeof dateInput === 'object' && dateInput.seconds) {
          date = new Date(dateInput.seconds * 1000);
        } else {
          date = new Date(dateInput);
        }
        if (isNaN(date.getTime())) return '—';
        return date.toLocaleString('ru-RU', {
          day: '2-digit', month: '2-digit', year: 'numeric',
          hour: '2-digit', minute: '2-digit'
        });
      }
  }
  }
</script>
</body>
</html>